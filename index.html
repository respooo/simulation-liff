<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>積立購入シミュレーション</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
</head>
<body>

    <form class="w-75 mx-auto">
        <p class="mt-3">積立シミュレーションしたい商品名をご記入ください。</p>
        <div>
            <input class="form-control w-100 mt-1" name="url" placeholder="" required>
        </div>
        <p class="mt-3">購入を検討している商品の金額を入力してください。カンマ入れずに入力をお願い致します。（半角数字, 例：50000）</p>
        <div>
            <input type="number" class="form-control w-100 mt-1" name="price" required>
        </div>
        <p class="mt-3">どちらの積立方法を検討していますか？ <br /><strong>1. 月々いくら貯金</strong><br />
            「月々いくらまでなら支払えるか」を入力して頂き、そこから商品単価を考慮し、「目標達成日」をシミュレーションします。
            <br /><strong>2. いつまで貯金</strong><br />
            「いつまでに欲しいか」を入力して頂き、そこから商品単価を考慮し、「月々の積立金額」をシミュレーションします。</p>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="type" id="every" value="every" required> 
            <label class="form-check-label" for="every">毎月の積立金額を決める（月々いくら貯金）</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="type" id="end" value="end" required> 
            <label class="form-check-label" for="end">積立達成の目標日を決める（いつまで貯金）</label>
        </div>
        <div id="amountOfMoney">
            <p class="mt-3">毎月積立てを行う金額を入力してください（半角数字, 例：5000）</p>
            <input id="amountOfMoneyForm" type="number" class="form-control w-100 mt-1" name="amountOfMoney">
        </div>
        <div id="endDate">
            <p class="mt-3">積立てを完了させたい日付を入力して下さい。積立期間は最低3ヶ月以上からになります。後からでも変更可能ですので、ご安心くださいませ。</p>
            <input id=""endDateForm type="date" class="form-control w-100 mt-1" name="endDate">
        </div>
        <div class="text-center">
            <input id="submit" type="submit" class="mt-4 btn btn-primary" value="送信">
        </div>
    </form>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        $(document).ready(function () {
            const liffId = "1657664942-ayvy63nv";
            initializeLiff(liffId);
            $('#amountOfMoney').css('display', 'none');
            $('#endDate').css('display', 'none');
        })

        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                initializeApp();
            }).catch((err) => {
                console.log('LIFF Initialization failed ', err);
            });
        }

        $(function () {
            $('input[name="type"]').change(function (e) {
                const val = $(this).val();
                if (val === 'every') {
                    $('#amountOfMoney').css('display', 'block');
                    $('#amountOfMoneyForm').attr('required', true)
                    $('#endDate').css('display', 'none');
                    $('#endDateForm').attr('required', false);
                } else if (val === 'end') {
                    $('#amountOfMoney').css('display', 'none');
                    $('#amountOfMoneyForm').attr('required', false)
                    $('#endDate').css('display', 'block');
                    $('#endDateForm').attr('required', true);
                }
            })
            $('form').submit(function (e) {
                $('#submit').prop('disabled', true);
                e.preventDefault();
                const url = $('input[name="url"]').val();
                const price = $('input[name="price"]').val();
                const type = $('input[name="type"]:checked').val();
                const amountOfMoney = $('input[name="amountOfMoney"]').val();
                const endDate = new Date($('input[name="endDate"]').val());
                const now = new Date();
                if (type === 'end' && (endDate.getFullYear() - now.getFullYear()) * 12 + (endDate.getMonth() - now.getMonth()) + 1 <= 2) {
                    alert('積立期間は最低3ヶ月以上必要です。')
                    return;
                }
                try {
                    liff.getProfile().then(function (profile) {
                        let msg = '';
                        msg += `name=${profile.displayName}&userId=${profile.userId}&url=${url}&price=${price}&type=${type}&`;
                        if (type === 'every') {
                            msg += `amountOfMoney=${amountOfMoney}`
                        } else if (type === 'end') {
                            msg += `endDate=${endDate.toString()}`;
                        }
                        $.ajax({
                            url: `https://script.google.com/macros/s/AKfycbz8phfYgCUSNJHIg0eFT9G2qKSebDXiZJoTmgCGq9-yvi9B4pcu0_HzstwODo8lY4RWUQ/exec?${msg}`,
                            method: 'post',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                        }).then(function () {
                            liff.closeWindow();
                            return false;
                        })
                    })
                } catch (e) {
                    window.alert('シミュレーションに失敗しました。入力した値が間違っていないかご確認ください。')
                }
            });
        });

    </script>

</body>
</html>