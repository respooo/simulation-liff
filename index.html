<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>積立購入シミュレーション</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
</head>
<body>

    <form class="w-75 mx-auto">
        <p class="mt-3">購入を検討している商品のURL - 購入を検討している商品のURLの添付をお願いいたします。
            （amazonや楽天などで販売されている商品のリンクの添付をお願いいたします。）</p>
        <div>
            <input class="form-control w-100 mt-1" name="url" placeholder="" required>
        </div>
        <p class="mt-3">購入を検討している商品の金額を入力してください - カンマ入れずに入力をお願い致します。（半角数字, 例：50000）</p>
        <div>
            <input type="number" class="form-control w-100 mt-1" name="price" required>
        </div>
        <p>どちらの積立方法を検討していますか？ - 1. 月々いくら貯金
            「月々いくらまでなら支払えるか」を入力して頂き、そこから商品単価を考慮し、「目標達成日」を算出します。
            2. いつまで貯金
            「いつまでに欲しいか」を入力して頂き、そこから商品単価を考慮し、「月々の積立金額」を算出します。</p>
        <div>
            <input class="form-control" type="radio" name="type" id="every" value="every" required checked> 
            <label for="every">毎月の積立金額を決める（月々いくら貯金）</label>
            <input class="form-control" type="radio" name="type" id="end" value="end" required> 
            <label for="end">積立達成の目標日を決める（いつまで貯金）</label>
        </div>
        <div id="amountOfMoney">
            <p>毎月積立てを行う金額を入力してください（半角数字, 例：5000）</p>
            <input type="number" class="form-control w-100 mt-1" name="amountOfMoney" required>
        </div>
        <div id="endDate">
            <p>積立てを完了させたい日付を入力して下さい - 積立期間は最低2ヶ月以上からになります。後からでも変更可能ですので、ご安心くださいませ。</p>
            <input type="date" class="form-control w-100 mt-1" name="endDate">
        </div>
        <input type="submit" class="mt-4 btn btn-primary" value="送信">
    </form>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        $(document).ready(function () {
            const liffId = "1657664942-ayvy63nv";
            initializeLiff(liffId);
            $('#endDate').css('display', 'none');
        })

        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                initializeApp();
            }).catch((err) => {
                console.log('LIFF Initialization failed ', err);
            });
        }

        $(function () {
            $('input[name="type"]').change(function (e) {
                const val = $(this).val();
                if (val === 'every') {
                    $('#amountOfMoney').css('display', 'block');
                    $('#endDate').css('display', 'none');
                } else if (val === 'end') {
                    $('#amountOfMoney').css('display', 'none');
                    $('#endDate').css('display', 'block');
                }
            })
            $('form').submit(function (e) {
                e.preventDefault();
                liff.getProfile().then(function (profile) {
                    let msg = '';
                    const url = $('input[name="url"]').val();
                    const price = $('input[name="price"]').val();
                    const type = $('input[name="type"]').val();
                    msg += `name=${profile.displayName}&userId=${profile.userId}&url=${url}&price=${price}&type=${type}&`;
                    if (type === 'every') {
                        const amountOfMoney = $('input[name="amountOfMoney"]').val();
                        msg += `amountOfMoney=${amountOfMoney}`
                    } else if (type === 'end') {
                        const endDate = $('input[name="endDate"]').val();
                        msg += `endDate=${endDate}`;
                    }
                    window.alert(msg);
                    $.ajax({
                        url: `https://script.google.com/macros/s/AKfycbxqFrcMPlMYoAIYFBlnjMmmyCV7FvNFMRZYOCMRg4nbhpI_34F8Yd-NCWSneFeQ2HmA/exec?${msg}`,
                        method: 'post',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                    }).then(function () {
                        liff.closeWindow();
                        return false;
                    }).catch(function(e) {
                        window.alert(e.message);
                    })
                })
            });
        });

    </script>

</body>
</html>